rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user is logged in
    function isAuth() {
      return request.auth != null;
    }

    // Helper function: Check if user is an Admin
    // Checks if the user's email exists in the 'admin_users' collection
    function isAdmin() {
      return isAuth() && exists(/databases/$(database)/documents/admin_users/$(request.auth.token.email));
    }

    // 1. Admin Users Collection (Only Admins can touch this)
    match /admin_users/{email} {
      allow read, write: if isAdmin();
    }

    // 2. Settings (Company Profile, etc.)
    match /settings/{document=**} {
      allow read: if isAuth(); // Employees need to see company name/logo
      allow write: if isAdmin();
    }

    // 3. Employees Collection
    match /employees/{empId} {
      allow read: if isAuth();
      allow write: if isAdmin() || (isAuth() && request.auth.token.email == resource.data.email);
    }

    // 4. Loans & Applications
    match /loans/{loanId} {
      allow read, write: if isAuth();
    }
    match /loan_applications/{appId} {
      allow read, write: if isAuth();
    }

    // 5. Financial Records (Expenses, Wallet, EMI)
    match /expenses/{docId} { allow read, write: if isAuth(); }
    match /wallet_transactions/{docId} { allow read, write: if isAuth(); }
    match /emi_schedule/{loanId} { allow read, write: if isAuth(); }
  }
}